<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Unwrapped</title>
    <link rel="stylesheet" href="homestyles.css">
</head>

<body>
    <!-- Navbar start -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="HomePage.html" class="navbar-logo">
                <div class="spotify-logo">
                    <svg width="132" height="37" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M19.3013 0.01485C9.05625 -0.390621 0.421794 7.55691 0.014902 17.7661C-0.39199 27.9769 7.58339 36.5812 17.8299 36.9852C28.0749 37.3906 36.7094 29.4431 37.1163 19.2339C37.5232 9.02463 29.5463 0.418779 19.3013 0.01485ZM27.1389 27.1166C26.9933 27.371 26.7523 27.5573 26.4689 27.6348C26.1855 27.7123 25.8829 27.6745 25.6274 27.5298C23.173 26.1381 20.4754 25.2241 17.6783 24.8364C14.8827 24.4408 12.037 24.5784 9.29296 25.2419C9.01291 25.2961 8.7227 25.2406 8.4826 25.0871C8.2425 24.9336 8.07098 24.6938 8.00367 24.4176C7.93636 24.1413 7.97843 23.8499 8.12115 23.6037C8.26386 23.3576 8.49625 23.1757 8.77003 23.0959C11.7869 22.3651 14.8889 22.2155 17.9878 22.6488C21.0866 23.0835 24.0261 24.0795 26.7243 25.6088C26.8509 25.6807 26.962 25.7767 27.0514 25.8914C27.1407 26.0061 27.2065 26.1372 27.245 26.2772C27.2835 26.4172 27.294 26.5634 27.2758 26.7074C27.2576 26.8515 27.2111 26.9905 27.1389 27.1166ZM29.5787 22.2602C29.4889 22.4262 29.3671 22.5729 29.2203 22.6919C29.0735 22.8109 28.9046 22.8999 28.7232 22.9537C28.5418 23.0076 28.3516 23.0252 28.1634 23.0057C27.9751 22.9862 27.7926 22.9298 27.6263 22.8399C24.7521 21.2915 21.6229 20.2681 18.3869 19.8182C15.1517 19.3618 11.8607 19.4861 8.66947 20.1851C8.48456 20.226 8.29338 20.23 8.10689 20.1971C7.9204 20.1641 7.74228 20.0948 7.58273 19.9931C7.42318 19.8914 7.28535 19.7594 7.17714 19.6045C7.06894 19.4496 6.99248 19.2749 6.95217 19.0905C6.91117 18.9062 6.90709 18.7157 6.94014 18.5299C6.9732 18.344 7.04275 18.1665 7.1448 18.0075C7.24686 17.8485 7.37941 17.7112 7.53485 17.6034C7.69029 17.4955 7.86557 17.4193 8.05062 17.3792C11.5765 16.6054 15.2132 16.4686 18.7876 16.9752C22.3638 17.4701 25.8217 18.6006 28.997 20.3131C29.6963 20.6908 29.9562 21.5618 29.5787 22.2602ZM32.2831 16.7856C32.0658 17.2013 31.6919 17.514 31.2434 17.655C30.7949 17.7961 30.3086 17.754 29.8913 17.538C26.5443 15.8039 22.9245 14.6527 19.1883 14.1339C15.4532 13.606 11.655 13.7181 7.9578 14.4653C7.49959 14.5521 7.02552 14.4555 6.6383 14.1964C6.25108 13.9373 5.98191 13.5366 5.88911 13.0812C5.79631 12.6257 5.88736 12.1521 6.14252 11.763C6.39769 11.374 6.79642 11.1008 7.25231 11.0026C11.3441 10.175 15.5477 10.0499 19.6818 10.6326C23.8172 11.2078 27.8235 12.4827 31.5281 14.4021C32.396 14.8523 32.7349 15.9192 32.2831 16.7856ZM53.3425 16.7301L52.0553 16.3493C49.4716 15.5862 48.7444 15.2994 48.7444 14.2634C48.7444 13.2813 49.8398 12.2175 52.2471 12.2175C54.6281 12.2175 56.6394 13.3769 57.6775 14.2372C57.8569 14.3852 58.0488 14.3173 58.0488 14.0861V10.6912C58.0488 10.5417 58.007 10.46 57.8972 10.3783C56.6131 9.42239 54.3821 8.72862 52.1372 8.72862C47.5686 8.72862 44.8318 11.3187 44.8318 14.2634C44.8318 17.5888 46.9529 18.7498 50.4416 19.7303L51.947 20.1527C54.56 20.8897 55.0381 21.5433 55.0381 22.5516C55.0381 24.2429 53.7524 24.7609 51.8356 24.7609C49.4282 24.7609 46.4872 23.3564 45.1056 21.6389C44.9818 21.4878 44.8318 21.5572 44.8318 21.7345V25.4701C44.8318 25.6196 44.8472 25.6875 44.9555 25.8093C46.105 27.0642 48.8543 28.1681 52.0568 28.1681C55.9958 28.1681 58.9507 25.8786 58.9507 22.3342C58.9507 19.5792 57.3232 17.9172 53.3425 16.7301ZM68.9792 14.0167C66.38 14.0167 64.8747 15.5985 63.999 17.1803V14.4545C63.999 14.3312 63.9309 14.2634 63.8071 14.2634H60.3725C60.2503 14.2634 60.1823 14.3312 60.1823 14.4545V31.9437C60.1823 32.0671 60.2503 32.1349 60.3741 32.1349H63.8087C63.9309 32.1349 63.999 32.0671 63.999 31.9437V24.9505C64.8747 26.5308 66.3521 28.0864 69.007 28.0864C72.5097 28.0864 75.0253 25.0723 75.0253 21.0238C75.0253 16.9752 72.4818 14.0167 68.9792 14.0167ZM67.9673 24.7871C66.134 24.7871 64.5467 22.9879 63.917 20.9976C64.5467 18.8978 65.9963 17.2898 67.9673 17.2898C69.8409 17.2898 71.1405 18.7081 71.1405 21.0253C71.1405 23.3425 69.8409 24.7871 67.9673 24.7871ZM130.831 14.2634H127.329C127.205 14.2634 127.151 14.2896 127.097 14.4129L123.566 22.8661L120.023 14.4129C119.969 14.2896 119.915 14.2634 119.791 14.2634H114.127V13.363C114.127 11.8907 115.125 11.2092 116.411 11.2092C117.178 11.2092 118.012 11.6039 118.6 11.9585C118.737 12.0402 118.832 11.9462 118.778 11.8228L117.546 8.89204C117.509 8.80291 117.441 8.7301 117.354 8.68699C116.753 8.37402 115.769 8.10114 114.811 8.10114C111.91 8.10114 110.241 10.3089 110.241 13.1179V14.2634H107.915C107.792 14.2634 107.724 14.3312 107.724 14.4545V17.1803C107.724 17.3036 107.792 17.3715 107.915 17.3715H110.241V27.6516C110.241 27.775 110.309 27.8412 110.433 27.8412H113.935C114.059 27.8412 114.127 27.7734 114.127 27.6516V17.3715H117.122L121.473 26.7913L119.134 31.9175C119.065 32.0686 119.147 32.1365 119.284 32.1365H123.018C123.142 32.1365 123.198 32.1087 123.25 31.9869L130.981 14.4808C131.036 14.3574 130.967 14.2634 130.831 14.2634Z"
                            fill="white" />
                    </svg>
                    <div class="Unwrapped">
                        Unwrapped
                    </div>
                </div>
            </a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="friends.html" class="nav-link">Friends</a></li>
                <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                <li class="nav-item"><a href="settings.html" class="nav-link">Settings</a></li>
            </ul>
        </div>
    </nav>
    <!-- Navbar end, Sidebar start -->
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-section">
                <h2>Dashboard</h2>
                <div class="sidebar-content">
                    <div id="chart-1" class="chart-container">
                        <h2>Graph?</h2>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <h2>Statistics</h2>
                <div class="sidebar-content">
                    <div id="stats-1" class="stats-container">
                        <h2>stats?</h2>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <h2>Navigation</h2>
                <ul class="sidebar-links">
                    <li><a href="#">Overview</a></li>
                    <li><a href="#">Top Artists</a></li>
                    <li><a href="#">Top Tracks</a></li>
                </ul>
            </div>
        </div>
        <!-- SideBar end, Right Content area start -->
        <div class="content-area">
            <div id="login-container">
                <button id="login-btn">Login with Spotify</button>
            </div>
            <div id="now-playing" style="display:none;">
                <h2>Now Playing</h2>
                <img id="album-art" src="" alt="Album Art" width="150" height="150" />
                <p><strong id="track-name"></strong></p>
                <p id="artist-name"></p>
                <p id="progress"></p>
            </div>
        </div>
    </div>

    <footer>
        <p>Made by Ted &amp; Kmy. Inspired by Spotify&copy; </p>
    </footer>

    <script>
        // ─── CONFIG ────────────────────────────────────────────────────────────────
        const clientId    = 'a4856be3325f43e7aa292960ca442375';  // ← replace with your Spotify Client ID, prob put as env variable
        const redirectUri = window.location.origin + window.location.pathname;
        const scopes      = 'user-read-playback-state';

        // ─── PKCE HELPERS ──────────────────────────────────────────────────────────
        function base64url(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        function randomString(len) {
            const arr = new Uint8Array(len);
            crypto.getRandomValues(arr);
            return Array.from(arr, v => ('0' + v.toString(16)).slice(-2)).join('');
        }
        async function makeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64url(hash);
        }

        // ─── STEP 1: REDIRECT TO SPOTIFY FOR CONSENT ────────────────────────────────
        async function login() {
            const verifier = randomString(64);
            localStorage.setItem('pkce_verifier', verifier);
            const challenge = await makeChallenge(verifier);
            const params = new URLSearchParams({
                response_type:         'code',
                client_id:             clientId,
                scope:                 scopes,
                redirect_uri:          redirectUri,
                code_challenge:        challenge,
                code_challenge_method: 'S256'
            });
            window.location = `https://accounts.spotify.com/authorize?${params}`;
        }

        // ─── STEP 2: EXCHANGE CODE FOR TOKENS ───────────────────────────────────────
        async function handleCallback() {
            const url  = new URL(window.location);
            const code = url.searchParams.get('code');
            if (!code) return;
            const verifier = localStorage.getItem('pkce_verifier');
            const body = new URLSearchParams({
                grant_type:    'authorization_code',
                code,
                redirect_uri:  redirectUri,
                client_id:     clientId,
                code_verifier: verifier
            });
            const res = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: { 'Content-Type':'application/x-www-form-urlencoded' },
                body
            });
            const data = await res.json();
            localStorage.setItem('access_token',  data.access_token);
            localStorage.setItem('refresh_token', data.refresh_token);
            localStorage.setItem('expiry',        Date.now() + data.expires_in * 1000);
            history.replaceState({}, '', redirectUri);
        }

        // ─── STEP 3: REFRESH TOKEN WHEN EXPIRED ────────────────────────────────────
        async function refreshIfNeeded() {
            const expiry = +localStorage.getItem('expiry') || 0;
            if (Date.now() < expiry) return;
            const refresh_token = localStorage.getItem('refresh_token');
            if (!refresh_token) return login();
            const body = new URLSearchParams({
                grant_type:    'refresh_token',
                refresh_token,
                client_id
            });
            const res = await fetch('https://accounts.spotify.com/api/token', {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body
            });
            const { access_token, expires_in } = await res.json();
            localStorage.setItem('access_token', access_token);
            localStorage.setItem('expiry',      Date.now() + expires_in * 1000);
        }

        // ─── STEP 4: FETCH CURRENTLY PLAYING ───────────────────────────────────────
        async function fetchCurrentlyPlaying() {
            await refreshIfNeeded();
            const token = localStorage.getItem('access_token');
            if (!token) return;
            const res = await fetch(
                'https://api.spotify.com/v1/me/player/currently-playing',
                { headers: { 'Authorization': 'Bearer ' + token } }
            );
            if (res.status === 204 || !res.ok) {
                document.getElementById('now-playing').style.display = 'none';
                return;
            }
            const data = await res.json();
            renderNowPlaying(data);
        }

        function renderNowPlaying(data) {
            const track = data.item;
            document.getElementById('login-container').style.display = 'none';
            const now = document.getElementById('now-playing');
            now.style.display = '';

            document.getElementById('album-art').src         = track.album.images[1].url;
            document.getElementById('track-name').textContent  = track.name;
            document.getElementById('artist-name').textContent = track.artists.map(a => a.name).join(', ');

            const prog = Math.floor((data.progress_ms / track.duration_ms) * 100);
            document.getElementById('progress').textContent =
                `Progress: ${Math.floor(data.progress_ms/1000)}s / ${Math.floor(track.duration_ms/1000)}s (${prog}%)`;
        }

        // ─── BOOTSTRAP ──────────────────────────────────────────────────────────────
        document.getElementById('login-btn').onclick = login;
        (async () => {
            await handleCallback();
            if (localStorage.getItem('access_token')) {
                fetchCurrentlyPlaying();
                setInterval(fetchCurrentlyPlaying, 15000);
            }
        })();
    </script>
</body>

</html>
