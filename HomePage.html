<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spotify Unwrapped</title>
  <link rel="stylesheet" href="homestyles.css" />
</head>
<body class="theme-dark">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="HomePage.html" class="navbar-logo">
        <!-- (Spotify SVG + Unwrapped title omitted for brevity) -->
      </a>
      <ul class="nav-menu">
        <li class="nav-item"><a href="HomePage.html" class="nav-link active">Home</a></li>
        <li class="nav-item"><a href="friends.html" class="nav-link">Friends</a></li>
        <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
        <li class="nav-item"><a href="settings.html" class="nav-link">Settings</a></li>
      </ul>
    </div>
  </nav>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Overview + Profile -->
      <div class="sidebar-section">
        <h2>Overview</h2>
        <div class="sidebar-content">
          <div id="user-profile" class="profile-container">
            <div class="profile-placeholder">
              <div class="profile-icon">
                <!-- user icon SVG -->
              </div>
              <p>Welcome! Login to see your profile</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Statistics -->
      <div class="sidebar-section">
        <h2>Your Statistics</h2>
        <div class="sidebar-content">
          <div id="stats-container" class="stats-container">
            <div class="stat-item">
              <div class="stat-icon"><!-- play icon --></div>
              <div class="stat-info">
                <span class="stat-value" id="track-count">0</span>
                <span class="stat-label">Tracks played</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon"><!-- timer icon --></div>
              <div class="stat-info">
                <span class="stat-value" id="listening-time">0h</span>
                <span class="stat-label">Listening time</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon"><!-- users icon --></div>
              <div class="stat-info">
                <span class="stat-value" id="artist-count">0</span>
                <span class="stat-label">Artists</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Navigation Links -->
      <div class="sidebar-section">
        <h2>Navigation</h2>
        <ul class="sidebar-links">
          <li><a href="#overview">Overview</a></li>
          <li><a href="#top-artists">Top Artists</a></li>
          <li><a href="#top-tracks">Top Tracks</a></li>
          <li><a href="#genres">Genres</a></li>
        </ul>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Login -->
      <div id="login-section" class="login-section">
        <h1>Discover Your Music Journey</h1>
        <p>Connect your Spotify account to see your listening patterns, discover your most-played tracks, and share insights with friends.</p>
        <button id="login-btn" class="login-button">
          <span>Connect with Spotify</span>
          <div class="border full-rounded"></div>
        </button>
      </div>

      <!-- Dashboard -->
      <div id="dashboard" class="dashboard" style="display:none;">
        <!-- 1) NOW PLAYING -->
        <section id="overview" class="dashboard-section">
          <div class="section-header"><h2>Now Playing</h2></div>
          <div id="now-playing" class="now-playing-card">
            <div class="now-playing-art">
              <img id="album-art" src="https://via.placeholder.com/150" alt="Album Art" />
              <div class="playing-indicator">
                <span></span><span></span><span></span><span></span>
              </div>
            </div>
            <div class="now-playing-info">
              <h3 id="track-name">Not Playing</h3>
              <p id="artist-name">-</p>
              <div class="progress-container">
                <div class="progress-bar"><div id="progress-fill" class="progress-fill"></div></div>
                <div class="progress-time">
                  <span id="current-time">0:00</span>
                  <span id="total-time">0:00</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 2) TOP TRACKS -->
        <section id="top-tracks" class="dashboard-section">
          <div class="section-header">
            <h2>Your Top Tracks</h2>
            <div class="timeframe-selector">
              <button class="timeframe-btn active" data-type="tracks" data-timeframe="short_term">4 Weeks</button>
              <button class="timeframe-btn" data-type="tracks" data-timeframe="medium_term">6 Months</button>
              <button class="timeframe-btn" data-type="tracks" data-timeframe="long_term">All Time</button>
            </div>
          </div>
          <div id="top-tracks-container" class="track-grid">
            <div class="loading-placeholder">
              <div class="spinner"></div>
              <p>Loading your top tracks...</p>
            </div>
          </div>
        </section>

        <!-- 3) GENRES -->
        <section id="top-genres" class="dashboard-section">
          <div class="section-header"><h2>Your Top Genres</h2></div>
          <div class="genres-container">
            <div class="genres-chart"><canvas id="genres-chart"></canvas></div>
            <div class="genres-list">
              <!-- static list or dynamic later -->
            </div>
          </div>
        </section>

        <!-- 4) RECENTLY PLAYED -->
        <section id="recently-played" class="dashboard-section">
          <div class="section-header"><h2>Recently Played</h2></div>
          <div class="track-grid">
            <!-- dynamically added -->
          </div>
        </section>

        <!-- 5) TOP ARTISTS -->
        <section id="top-artists" class="dashboard-section">
          <div class="section-header">
            <h2>Your Top Artists</h2>
            <div class="timeframe-selector">
              <button class="timeframe-btn active" data-type="artists" data-timeframe="short_term">4 Weeks</button>
              <button class="timeframe-btn" data-type="artists" data-timeframe="medium_term">6 Months</button>
              <button class="timeframe-btn" data-type="artists" data-timeframe="long_term">All Time</button>
            </div>
          </div>
          <div id="top-artists-container" class="artists-grid">
            <div class="loading-placeholder">
              <div class="spinner"></div>
              <p>Loading your top artists...</p>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <footer>
    <p>Made with love by Ted &amp; Kmy. Inspired by Spotify&copy;</p>
  </footer>

  <!-- Script: Auth + Fetch + Render -->
  <script>
    // ─── CONFIG ────────────────────────────────────────────────────────────────
    const clientId   = '27544f129c784987883db9933a501d42';
    const redirectUri= window.location.origin + window.location.pathname;
    const scopes     = 'user-read-playback-state user-read-recently-played user-top-read';

    // ─── PKCE HELPERS ──────────────────────────────────────────────────────────
    function base64url(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    function randomString(len) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, v => ('0' + v.toString(16)).slice(-2)).join('');
    }
    async function makeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return base64url(hash);
    }

    // ─── AUTH FLOW ─────────────────────────────────────────────────────────────
    async function login() {
      const verifier = randomString(64);
      localStorage.setItem('pkce_verifier', verifier);
      const challenge = await makeChallenge(verifier);
      const params = new URLSearchParams({
        response_type: 'code', client_id: clientId, scope: scopes,
        redirect_uri: redirectUri, code_challenge: challenge,
        code_challenge_method: 'S256'
      });
      window.location = `https://accounts.spotify.com/authorize?${params}`;
    }

    async function handleCallback() {
      const code = new URL(window.location).searchParams.get('code');
      if (!code) return false;
      const verifier = localStorage.getItem('pkce_verifier');
      const body = new URLSearchParams({
        grant_type:'authorization_code', code, redirect_uri: redirectUri,
        client_id: clientId, code_verifier: verifier
      });
      try {
        const res = await fetch('https://accounts.spotify.com/api/token',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const data = await res.json();
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        localStorage.setItem('expiry', Date.now() + data.expires_in * 1000);
        history.replaceState({}, '', redirectUri);
        return true;
      } catch(err) {
        console.error('Token exchange error', err);
        return false;
      }
    }

    // ─── TOKEN REFRESH ─────────────────────────────────────────────────────────
    async function refreshIfNeeded() {
      const expiry = +localStorage.getItem('expiry') || 0;
      if (Date.now() < expiry) return true;
      const refresh_token = localStorage.getItem('refresh_token');
      if (!refresh_token) return false;
      const body = new URLSearchParams({
        grant_type:'refresh_token', refresh_token, client_id: clientId
      });
      try {
        const res = await fetch('https://accounts.spotify.com/api/token',{
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body
        });
        const { access_token, expires_in } = await res.json();
        localStorage.setItem('access_token', access_token);
        localStorage.setItem('expiry', Date.now() + expires_in*1000);
        return true;
      } catch(err) {
        console.error('Refresh error', err);
        return false;
      }
    }

    // ─── FETCH HELPERS ─────────────────────────────────────────────────────────
    async function fetchUserProfile() {
      if (!await refreshIfNeeded()) return null;
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch('https://api.spotify.com/v1/me',{
          headers:{Authorization:'Bearer '+ token}
        });
        if (!res.ok) throw new Error();
        return await res.json();
      } catch { return null; }
    }
    async function fetchCurrentlyPlaying() {
      if (!await refreshIfNeeded()) return null;
      const token = localStorage.getItem('access_token');
      const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing',{
        headers:{Authorization:'Bearer '+ token}
      });
      if (res.status === 204) return null;
      if (!res.ok) throw new Error();
      return await res.json();
    }
    async function fetchTopItems(type, timeRange='medium_term', limit=10) {
      if (!await refreshIfNeeded()) return null;
      const token = localStorage.getItem('access_token');
      const res = await fetch(
        `https://api.spotify.com/v1/me/top/${type}?time_range=${timeRange}&limit=${limit}`,{
          headers:{Authorization:'Bearer '+ token}
        }
      );
      if (!res.ok) throw new Error();
      return await res.json();
    }
    async function fetchRecentlyPlayed(limit=10) {
      if (!await refreshIfNeeded()) return null;
      const token = localStorage.getItem('access_token');
      const res = await fetch(
        `https://api.spotify.com/v1/me/player/recently-played?limit=${limit}`,{
          headers:{Authorization:'Bearer '+ token}
        }
      );
      if (!res.ok) throw new Error();
      return await res.json();
    }

    // ─── RENDERERS ─────────────────────────────────────────────────────────────
    function renderNowPlaying(data) {
      const trackName = document.getElementById('track-name');
      const artistName= document.getElementById('artist-name');
      const artImg     = document.getElementById('album-art');
      const fillBar    = document.getElementById('progress-fill');
      const curT       = document.getElementById('current-time');
      const totT       = document.getElementById('total-time');
      const indicator  = document.querySelector('.playing-indicator');

      if (!data || !data.item) {
        trackName.textContent = 'Nothing playing right now';
        artistName.textContent= 'Play something on Spotify';
        artImg.src = 'https://via.placeholder.com/150';
        fillBar.style.width = '0%';
        curT.textContent = totT.textContent = '0:00';
        indicator.style.display = 'none';
        return;
      }

      const track = data.item;
      artImg.src = track.album.images[0].url;
      trackName.textContent = track.name;
      artistName.textContent = track.artists.map(a=>a.name).join(', ');
      const pct = Math.floor((data.progress_ms / track.duration_ms)*100);
      fillBar.style.width = pct + '%';

      const fmt = ms => {
        const m = Math.floor(ms/60000);
        const s = String(Math.floor((ms%60000)/1000)).padStart(2,'0');
        return `${m}:${s}`;
      };
      curT.textContent = fmt(data.progress_ms);
      totT.textContent = fmt(track.duration_ms);
      indicator.style.display = data.is_playing ? 'flex' : 'none';
    }

    function renderTopTracks(data) {
      const container = document.getElementById('top-tracks-container');
      if (!data || !data.items) {
        container.innerHTML = '<p>No track data available.</p>';
        return;
      }
      container.innerHTML = '';
      data.items.forEach(track => {
        const url = (track.album.images[0]||{}).url || 'https://via.placeholder.com/100';
        const card = document.createElement('div');
        card.className = 'track-card';
        card.innerHTML = `
          <div class="track-image">
            <img src="${url}" alt="${track.name}">
          </div>
          <div class="track-info">
            <h3 class="track-title">${track.name}</h3>
            <p class="track-artist">${track.artists.map(a=>a.name).join(', ')}</p>
          </div>`;
        container.appendChild(card);
      });
    }

    function renderTopArtists(data) {
      const container = document.getElementById('top-artists-container');
      if (!data || !data.items) {
        container.innerHTML = '<p>No artist data available.</p>';
        return;
      }
      container.innerHTML = '';
      data.items.forEach(artist => {
        const url = (artist.images[0]||{}).url || 'https://via.placeholder.com/150';
        const card = document.createElement('div');
        card.className = 'artist-card';
        card.innerHTML = `
          <div class="artist-image">
            <img src="${url}" alt="${artist.name}">
          </div>
          <div class="artist-info">
            <h3 class="artist-name">${artist.name}</h3>
            <p class="artist-genre">${(artist.genres[0]||'Unknown genre')}</p>
          </div>`;
        container.appendChild(card);
      });
    }

    // ─── MAIN INIT ────────────────────────────────────────────────────────────
    async function initApp() {
      await handleCallback();
      const token     = localStorage.getItem('access_token');
      const isLoggedIn= token && await refreshIfNeeded();

      if (!isLoggedIn) {
        document.getElementById('login-section').style.display = 'block';
        return;
      }
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';

      // Profile
      const profile = await fetchUserProfile();
      if (profile) {
        const p = document.getElementById('user-profile');
        p.innerHTML = `
          <div class="user-profile">
            <div class="profile-image">
              <img src="${(profile.images[0]||{}).url||'https://via.placeholder.com/40'}" alt="Profile">
            </div>
            <div class="profile-info">
              <h3>${profile.display_name}</h3>
              <p>${profile.followers.total} followers</p>
            </div>
          </div>`;
      }

      // Now Playing
      renderNowPlaying(await fetchCurrentlyPlaying());

      // Initial Top Tracks + Artists
      renderTopTracks(await fetchTopItems('tracks','medium_term',10));
      renderTopArtists(await fetchTopItems('artists','medium_term',8));

      // Timeframe selectors
      document.querySelectorAll('.timeframe-btn').forEach(btn=>{
        btn.addEventListener('click', async function(){
          const type = this.dataset.type;
          document.querySelectorAll(`.timeframe-btn[data-type="${type}"]`)
            .forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          const tf = this.dataset.timeframe;
          if (type==='tracks') {
            renderTopTracks(await fetchTopItems('tracks',tf,10));
          } else {
            renderTopArtists(await fetchTopItems('artists',tf,8));
          }
        });
      });

      // Poll for now playing every 5s
      setInterval(async ()=>{
        renderNowPlaying(await fetchCurrentlyPlaying());
      }, 5000);
    }

    document.getElementById('login-btn').addEventListener('click', login);
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
