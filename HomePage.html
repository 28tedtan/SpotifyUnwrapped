<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Unwrapped</title>
  <link rel="stylesheet" href="homestyles.css">
</head>

<body class="theme-dark">
  <!-- Navbar start -->
  <nav class="navbar">
    <div class="navbar-container">
      <a href="HomePage.html" class="navbar-logo">
        <div class="spotify-logo">
          <!-- Spotify SVG omitted for brevity -->
          <div class="Unwrapped">Unwrapped</div>
        </div>
      </a>
      <ul class="nav-menu">
        <li class="nav-item"><a href="HomePage.html" class="nav-link active">Home</a></li>
        <li class="nav-item"><a href="friends.html" class="nav-link">Friends</a></li>
        <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
        <li class="nav-item"><a href="settings.html" class="nav-link">Settings</a></li>
      </ul>
    </div>
  </nav>
  <!-- Navbar end -->

  <div class="main-container">
    <div class="sidebar">
      <!-- User Profile -->
      <div class="sidebar-section">
        <h2>Overview</h2>
        <div class="sidebar-content">
          <div id="user-profile" class="profile-container">
            <div class="profile-placeholder">
              <div class="profile-icon">
                <!-- User icon SVG omitted -->
              </div>
              <p>Welcome! Login to see your profile</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Your Statistics -->
      <div class="sidebar-section">
        <h2>Your Statistics</h2>
        <div class="sidebar-content">
          <div id="stats-container" class="stats-container">
            <div class="stat-item">
              <div class="stat-icon"><!-- play icon SVG --></div>
              <div class="stat-info">
                <span class="stat-value" id="track-count">0</span>
                <span class="stat-label">Tracks played</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon"><!-- timer icon SVG --></div>
              <div class="stat-info">
                <span class="stat-value" id="listening-time">0h</span>
                <span class="stat-label">Listening time</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon"><!-- users icon SVG --></div>
              <div class="stat-info">
                <span class="stat-value" id="artist-count">0</span>
                <span class="stat-label">Artists</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="sidebar-section">
        <h2>Navigation</h2>
        <ul class="sidebar-links">
          <li><a href="#overview">Overview</a></li>
          <li><a href="#top-artists">Top Artists</a></li>
          <li><a href="#top-tracks">Top Tracks</a></li>
          <li><a href="#genres">Genres</a></li>
        </ul>
      </div>
    </div>

    <!-- Content area start -->
    <div class="content-area">
      <!-- Login section -->
      <div id="login-section" class="login-section">
        <h1>Discover Your Music Journey</h1>
        <p>Connect your Spotify account to see your listening patterns, discover your most-played tracks, and share insights with friends.</p>
        <button id="login-btn" class="login-button">
          <span>Connect with Spotify</span>
          <div class="border full-rounded"></div>
        </button>
      </div>

      <!-- Dashboard (hidden until login) -->
      <div id="dashboard" class="dashboard" style="display:none;">
        
        <!-- Now Playing Section -->
        <section id="overview" class="dashboard-section">
          <div class="section-header"><h2>Now Playing</h2></div>
          <div id="now-playing" class="now-playing-card">
            <div class="now-playing-art">
              <img id="album-art" src="https://via.placeholder.com/150" alt="Album Art" />
              <div class="playing-indicator">
                <span></span><span></span><span></span><span></span>
              </div>
            </div>
            <div class="now-playing-info">
              <h3 id="track-name">Not Playing</h3>
              <p id="artist-name">-</p>
              <!-- Album name placeholder -->
              <p id="album-name">-</p>
              <div class="progress-container">
                <div class="progress-bar">
                  <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="progress-time">
                  <span id="current-time">0:00</span>
                  <span id="total-time">0:00</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Your Top Genres -->
        <section id="top-genres" class="dashboard-section">
          <div class="section-header"><h2>Your Top Genres</h2></div>
          <div class="genres-container">
            <div class="genres-chart"><canvas id="genres-chart"></canvas></div>
            <div class="genres-list">
              <div class="genre-item">
                <div class="genre-color" style="background-color: rgba(29, 185, 84, 0.8);"></div>
                <span class="genre-name">Pop</span><span class="genre-percentage">35%</span>
              </div>
              <div class="genre-item">
                <div class="genre-color" style="background-color: rgba(29, 185, 84, 0.6);"></div>
                <span class="genre-name">Rock</span><span class="genre-percentage">25%</span>
              </div>
              <div class="genre-item">
                <div class="genre-color" style="background-color: rgba(29, 185, 84, 0.4);"></div>
                <span class="genre-name">Hip-Hop</span><span class="genre-percentage">20%</span>
              </div>
              <div class="genre-item">
                <div class="genre-color" style="background-color: rgba(29, 185, 84, 0.2);"></div>
                <span class="genre-name">Electronic</span><span class="genre-percentage">15%</span>
              </div>
              <div class="genre-item">
                <div class="genre-color" style="background-color: rgba(29, 185, 84, 0.1);"></div>
                <span class="genre-name">Other</span><span class="genre-percentage">5%</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Recently Played placeholder -->
        <section id="recently-played" class="dashboard-section">
          <div class="section-header"><h2>Recently Played</h2></div>
          <div class="track-grid">
            <div class="track-card">
              <div class="track-image"><img src="https://via.placeholder.com/100" alt="Track cover"></div>
              <div class="track-info">
                <h3 class="track-title">Track Title</h3>
                <p class="track-artist">Artist Name</p>
              </div>
              <div class="track-played"><span>3 mins ago</span></div>
            </div>
            <!-- More track cards… -->
          </div>
        </section>

        <!-- Top Artists -->
        <section id="top-artists" class="dashboard-section">
          <div class="section-header">
            <h2>Your Top Artists</h2>
            <div class="timeframe-selector">
              <button class="timeframe-btn active" data-timeframe="short_term">4 Weeks</button>
              <button class="timeframe-btn" data-timeframe="medium_term">6 Months</button>
              <button class="timeframe-btn" data-timeframe="long_term">All Time</button>
            </div>
          </div>
          <div id="top-artists-container" class="artists-grid">
            <div class="loading-placeholder">
              <div class="spinner"></div>
              <p>Loading your top artists...</p>
            </div>
          </div>
        </section>

      </div>
      <!-- Dashboard end -->

    </div>
    <!-- Content area end -->
  </div>
  <!-- Main container end -->

  <footer>
    <p>Made with love by Ted &amp; Kmy. Inspired by Spotify&copy;</p>
  </footer>

  <!-- Unified Script with 1s polling & detailed comments for spotify apis yeah -->
  <script>
    // ─────────────── CONFIGURATION ───────────────
    const clientId    = 'SPOTIFYAPIKEY';
    const redirectUri = window.location.origin + window.location.pathname;
    const scopes      = 'user-read-playback-state user-read-recently-played user-top-read';

    // ─────────────── PKCE HELPERS ───────────────
    function base64url(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    function randomString(len) {
      const arr = new Uint8Array(len);
      crypto.getRandomValues(arr);
      return Array.from(arr, v => ('0' + v.toString(16)).slice(-2)).join('');
    }
    async function makeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return base64url(hash);
    }

    // ─────────────── THEME MANAGEMENT ───────────────
    if (localStorage.getItem('theme') === 'light') {
      document.body.classList.replace('theme-dark', 'theme-light');
    }

    // ─────────────── STEP 1: LOGIN ───────────────
    async function login() {
      const verifier = randomString(64);
      localStorage.setItem('pkce_verifier', verifier);
      const challenge = await makeChallenge(verifier);
      const params = new URLSearchParams({
        response_type:      'code',
        client_id:          clientId,
        scope:              scopes,
        redirect_uri:       redirectUri,
        code_challenge:     challenge,
        code_challenge_method: 'S256'
      });
      window.location = `https://accounts.spotify.com/authorize?${params}`;
    }

    // ─────────────── STEP 2: HANDLE CALLBACK ───────────────
    async function handleCallback() {
      const code = new URL(window.location).searchParams.get('code');
      if (!code) return false;
      const verifier = localStorage.getItem('pkce_verifier');
      const body = new URLSearchParams({
        grant_type:    'authorization_code',
        code,
        redirect_uri:  redirectUri,
        client_id:     clientId,
        code_verifier: verifier
      });
      try {
        const res  = await fetch('https://accounts.spotify.com/api/token', {
          method:  'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        const data = await res.json();
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('refresh_token', data.refresh_token);
        localStorage.setItem('expiry', Date.now() + data.expires_in * 1000);
        history.replaceState({}, '', redirectUri);
        return true;
      } catch (err) {
        console.error('Token exchange error:', err);
        return false;
      }
    }

    // ─────────────── STEP 3: REFRESH TOKEN ───────────────
    async function refreshIfNeeded() {
      const expiry = +localStorage.getItem('expiry') || 0;
      if (Date.now() < expiry) return true;
      const refresh_token = localStorage.getItem('refresh_token');
      if (!refresh_token) return false;
      const body = new URLSearchParams({
        grant_type:    'refresh_token',
        refresh_token,
        client_id:     clientId
      });
      try {
        const res = await fetch('https://accounts.spotify.com/api/token', {
          method:  'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body
        });
        const { access_token, expires_in } = await res.json();
        localStorage.setItem('access_token', access_token);
        localStorage.setItem('expiry', Date.now() + expires_in * 1000);
        return true;
      } catch (err) {
        console.error('Refresh token error:', err);
        return false;
      }
    }

    // ─────────────── FETCH PROFILE ───────────────
    async function fetchUserProfile() {
      await refreshIfNeeded();
      const token = localStorage.getItem('access_token');
      if (!token) return null;
      try {
        const res = await fetch('https://api.spotify.com/v1/me', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Profile fetch failed');
        return await res.json();
      } catch (err) {
        console.error('fetchUserProfile error:', err);
        return null;
      }
    }

    // ─────────────── FETCH CURRENTLY PLAYING ───────────────
    async function fetchCurrentlyPlaying() {
      await refreshIfNeeded();
      const token = localStorage.getItem('access_token');
      if (!token) return null;
      try {
        const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (res.status === 204) return null;
        if (!res.ok) throw new Error('Currently playing fetch failed');
        return await res.json();
      } catch (err) {
        console.error('fetchCurrentlyPlaying error:', err);
        return null;
      }
    }

    // ─────────────── RENDER NOW PLAYING ───────────────
    function renderNowPlaying(data) {
      const trackNameEl  = document.getElementById('track-name');
      const artistNameEl = document.getElementById('artist-name');
      const albumNameEl  = document.getElementById('album-name');
      const albumArtEl   = document.getElementById('album-art');
      const indicator    = document.querySelector('.playing-indicator');

      if (!data || !data.item) {
        trackNameEl.textContent  = 'Nothing playing right now';
        artistNameEl.textContent = '';
        albumNameEl.textContent  = '';
        albumArtEl.src           = 'https://via.placeholder.com/150';
        document.getElementById('progress-fill').style.width = '0%';
        document.getElementById('current-time').textContent  = '0:00';
        document.getElementById('total-time').textContent    = '0:00';
        indicator.style.display = 'none';
        return;
      }

      const track = data.item;
      trackNameEl.textContent  = track.name;
      artistNameEl.textContent = track.artists.map(a => a.name).join(', ');
      albumNameEl.textContent  = track.album.name;
      albumArtEl.src           = track.album.images[0].url;
      indicator.style.display  = data.is_playing ? 'flex' : 'none';
      updateProgressUI(data.progress_ms, track.duration_ms);
    }

    // ─────────────── UPDATE PROGRESS UI ───────────────
    function updateProgressUI(progress_ms, duration_ms) {
      const pct = Math.floor((progress_ms / duration_ms) * 100);
      document.getElementById('progress-fill').style.width = `${pct}%`;
      const fmt = ms => {
        const m = Math.floor(ms / 60000);
        const s = String(Math.floor((ms % 60000) / 1000)).padStart(2, '0');
        return `${m}:${s}`;
      };
      document.getElementById('current-time').textContent = fmt(progress_ms);
      document.getElementById('total-time').textContent   = fmt(duration_ms);
    }

    // ─────────────── PROGRESS POLLING ───────────────
    let progressPoll = null;
    function startProgressPolling() {
      clearInterval(progressPoll);
      progressPoll = setInterval(async () => {
        const data = await fetchCurrentlyPlaying();
        if (data && data.item && data.is_playing) {
          updateProgressUI(data.progress_ms, data.item.duration_ms);
        }
      }, 500);
    }

    // ─────────────── TRACK POLLING (1s) ───────────────
    function startTrackPolling() {
      setInterval(async () => {
        const data = await fetchCurrentlyPlaying();
        renderNowPlaying(data);
      }, 1000);
    }

    // ─────────────── INITIALIZE APP ───────────────
    async function initApp() {
      await handleCallback();
      const isLoggedIn = localStorage.getItem('access_token') && await refreshIfNeeded();

      if (isLoggedIn) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard').style.display     = 'block';

        // load sidebar profile if desired…
        const profile = await fetchUserProfile();
        if (profile) {
          // inject profile into #user-profile…
        }

        // initial render & start polling
        const data = await fetchCurrentlyPlaying();
        renderNowPlaying(data);
        startProgressPolling();
        startTrackPolling();

        // add top-artists handlers, etc.
      } else {
        document.getElementById('login-section').style.display = 'block';
        document.getElementById('dashboard').style.display     = 'none';
      }
    }

    // ─────────────── BOOTSTRAP ───────────────
    document.getElementById('login-btn').addEventListener('click', login);
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>

</html>